## Exercise 5 - Post Migration Changes for Service Layer

In this exercise we will make some adjustments manually once the project is created,as these are not currently handled by the SAP HANA Application Migration Assistant.
>[!Note]
>Service layer code is AI-generated, and the output may vary each time. You may need to manually validate and modify the code to align with your specific project needs.

## Service layer changes

1. In migrated cap application open package.json, add `"type": "module",`

<br>![](/exercises/ex5/images/typemodule.png)

2. open `srv/core-xsjs/lib/sap/hana/democontent/epm/services/service.js`, replace  the below service handlers code for proper scope and better readability
   ```
   import po_create_before_exit from './handlers/purchaseOrderExits.js';
   import my_create_after_exit,  my_update_after_exit  from './handlers/userExit.js';

   export default (srv) => {

   srv.on('CREATE','Users', async (req) => {
      const userdata = await my_create_after_exit(req);
      return userdata;
   });

   srv.on('UPDATE','Users', async (req) => {
      const userupdate = await my_update_after_exit(req);
      return userupdate;
   });
        
   srv.on('CREATE','purchaseDetails', async (req) => {
      const poid = await po_create_before_exit(req.data);
      return { message: `Purchase Order ${poid} created successfully` };
   });
        
   }
   ```
>[!Note]
> For the handlers code, there might be issues with the export statements, need manual fix

3. open `srv/core-xsjs/lib/sap/hana/democontent/epm/services/handlers/poWorklistQuery.js` and change the import statement
   ```
    import  MESSAGES  from './messages.js';
    import  SESSIONINFO  from './session.js';
    import NodeZip from "node-zip";
   ```
    navigate to the root project in the terminal and run ` npm install node-zip `

4. open `srv/core-xsjs/lib/sap/hana/democontent/epm/services/custom-service.cds`, rewrite the service definition with a unique service name, modify the endpoint to use a function or action, and add the required parameters as shown below
   ```
   service BusinessPartners {
    action poWorklistUpdate(cmd : String, payload: array of {
        purchaseOrderId: String;
        Action: String;
    }) returns String;
    function poWorklistQuery(cmd : String) returns String;
   }
   ```

5. For the handlers code, there might be issues with the logic or the cds query statements, replace the below logic under `srv/core-xsjs/lib/sap/hana/democontent/epm/services/handlers/userExit.js`
```
export async function my_update_after_exit(req) {
    try {
        let FirstName = req.data.FirstName;
        let LastName = req.data.LastName;
        let Email = req.data.Email;
        let UserId = req.data.UserId;
        await UPDATE('USERDATA_USER').set({ 
            FIRSTNAME: FirstName, 
            LASTNAME: LastName,
            EMAIL: Email 
        }).where({ USERID: UserId});
        return req.data;
    } catch (e) {
        console.error(e);
    }
}
```

6. Run `cds watch --profile hybrid` command in the root folder of the target cap project

> **Disclaimer:** The service layer code generated by the migration assistant is AI-driven, and the output may differ for each migration. Ensure you review and adjust the code as needed to meet your project requirements.

## Summary

You've now successfully completed the post migration steps for service layer of the CAP project.

Continue to - [Exercise 5 - Test the Application Locally](../ex6/README.md)